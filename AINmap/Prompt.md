角色： 你是一位精通 Python 的高级安全自动化工程师。你的专长是集成外部工具（如 Nmap）和本地 AI 模型（通过 Ollama）来创建高效的审计工作流。
任务：
编写一个健壮的 Python 脚本，该脚本可以自动化执行 Nmap 扫描，并将扫描结果发送给本地 Ollama LLM 进行分析，最终为每个目标生成一份详细的安全分析报告。
核心功能要求：
目标输入：
脚本必须从一个名为 targets.txt 的文件中读取扫描目标。
文件中的每一行都代表一个目标（可以是 IP 地址或域名）。
脚本需要能循环处理文件中的所有目标。
Nmap 扫描执行：
对每个目标，使用 Python 的 subprocess 模块执行 Nmap 命令。
必须使用全面扫描模式 (-A) 并以 XML 格式输出结果 (-oX -)，以便于解析。示例命令：nmap -A -oX - <target>。
捕获 Nmap 的 XML 输出以供后续分析。
与 Ollama 的 AI 集成：
使用 ollama Python 库与本地 Ollama 服务进行交互。
模型配置： 脚本顶部应有一个可配置的变量 OLLAMA_MODEL，默认设置为 'gemma' (注意，Ollama 官方模型名称可能是 gemma 而非 gemma3)。用户可以轻松修改此变量以使用其他模型。
将 Nmap 的 XML 输出作为上下文，构建一个精确的提示（Prompt）发送给 Ollama 模型。
AI 分析提示模板：
在脚本中，使用以下结构化提示模板来指导 AI 进行分析。这将确保报告的一致性和高质量。
<TEXT>
你是一名顶级的网络安全分析专家。你的任务是分析以下 Nmap 扫描的 XML 输出数据，并生成一份专业的安全评估报告。
 
Nmap XML 输出数据如下：
{nmap_xml_output}
<TEXT>
 
请根据以上数据，生成一份 Markdown 格式的详细报告，必须包含以下部分：
 
### 1. 摘要 (Executive Summary)
对目标的整体安全状况进行高度概括的总结，点出最关键的发现。
 
### 2. 开放端口和服务分析 (Open Ports & Services)
以 Markdown 表格形式列出所有发现的开放端口。表格应包括：端口号、协议、状态、服务名称和已识别的版本号。
 
### 3. 潜在风险和漏洞评估 (Potential Risks & Vulnerabilities)
- 逐一分析每个开放端口上的服务。
- 根据服务及其版本号，指出任何已知的、潜在的漏洞（例如，"vsftpd 2.3.4 存在已知的后门漏洞"）。
- 评估可能的配置弱点（例如，"开放的 FTP 端口可能允许匿名登录"）。
- 将风险按高、中、低进行初步评级。
 
### 4. 修复建议 (Remediation Steps)
- 提供具体、可操作的修复建议来解决上述发现的每一个风险。
- 建议应按优先级排序（从最高风险开始）。
- 示例：更新软件版本、应用安全补丁、关闭不必要的端口、加强防火墙规则等。
报告输出：
为每个扫描的目标生成一个独立的 Markdown (.md) 文件。
文件名应基于目标地址，例如 report_192.168.1.1.md 或 report_example.com.md。
代码质量和健壮性：
代码结构清晰，使用函数来封装不同逻辑（如 run_nmap_scan, analyze_with_ollama, main）。
添加有意义的注释来解释代码的关键部分。
实现基本的错误处理：
检查 nmap是否已安装。
处理 targets.txt 文件不存在的情况。
处理目标无响应或 Nmap 扫描失败的情况。
处理与 Ollama API 通信失败的情况。
在脚本的开头或结尾，提供 requirements.txt 的内容。
最终交付：
请提供完整的 Python 脚本 scan_analyzer.py。